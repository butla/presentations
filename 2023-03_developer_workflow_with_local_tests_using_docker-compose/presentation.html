<!DOCTYPE html>
<!--
  Copyright 2010 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)

  landslide modifications: Adam Zapletal (adamzap@gmail.com)
                           Nicolas Perriault (nperriault@gmail.com)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Developer workflow with local tests using Docker Compose</title>

  
     <link rel="stylesheet" href="file:///home/butla/development/presentations/2023-03_developer_workflow_with_local_tests_using_docker-compose/.venv/lib/python3.10/site-packages/darkslide/themes/default/css/base.css">
  

  
     <link rel="stylesheet" href="file:///home/butla/development/presentations/2023-03_developer_workflow_with_local_tests_using_docker-compose/.venv/lib/python3.10/site-packages/darkslide/themes/default/css/print.css">
  

  
     <link rel="stylesheet" href="file:///home/butla/development/presentations/2023-03_developer_workflow_with_local_tests_using_docker-compose/.venv/lib/python3.10/site-packages/darkslide/themes/default/css/screen.css">
  

  
     <link rel="stylesheet" href="file:///home/butla/development/presentations/2023-03_developer_workflow_with_local_tests_using_docker-compose/void_theme/css/theme.css">
  


  
    <script type="text/javascript" src="file:///home/butla/development/presentations/2023-03_developer_workflow_with_local_tests_using_docker-compose/.venv/lib/python3.10/site-packages/darkslide/themes/default/js/slides.js"></script>
  

</head>
<body>
  <div id="blank"></div>
  <div class="presentation">
    <div id="current_presenter_notes">
      <div id="presenter_note"></div>
    </div>
    <div class="slides">
      
      <!-- slide source: slides.md -->
      <div class="slide-wrapper">
        <div class="slide slide-1">
          <div class="inner">
            
            <header><h1>Developer workflow with local tests using Docker Compose</h1></header>
            
            
            <section><p>Michał Bultrowicz</p>
<p>https://bultrowicz.com</p>
<p>https://witchsoft.com</p>
<p>https://twitter.com/mmmbultrowicz</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <p>Tutaj zrobić tyci wprowadzenia o mnie?</p>
            
            </section>
          </div>
          <footer>
            
            
            <aside class="source">
              Source: <a href="slides.md">slides.md</a>
            </aside>
            
            <aside class="page_number">
              1/7
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: slides.md -->
      <div class="slide-wrapper">
        <div class="slide slide-2">
          <div class="inner">
            
            <header><h1>About me (TODO - wywal, chyba)</h1></header>
            
            
            <section><ul>
<li>mainly worked on Python back-ends</li>
<li>quality assurance</li>
<li>data engineering</li>
<li>tech leadership</li>
<li>Java, C++, C# in the past</li>
<li>I plan to post more educational material in the future</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <p>Tytuł wymyśliłem. Ale wszystkie są zmyślone, a część jest rozdmuchana.
Chief Executive Officer. Pffft... Po prostu "szef" nie można?</p>
<p>Będę potem wrzucał jakieś filmiki techniczne na jutuby, produkował w formie tekstowej na bloga,
i w formie jakiegoś minimalnego shitcontentu na Twittera i Instagrama :)</p>
            
            </section>
          </div>
          <footer>
            
            
            <aside class="source">
              Source: <a href="slides.md">slides.md</a>
            </aside>
            
            <aside class="page_number">
              2/7
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: slides.md -->
      <div class="slide-wrapper">
        <div class="slide slide-3">
          <div class="inner">
            
            <header><h1>What's a container?</h1></header>
            
            
            <section><p>It contains the application code, and all the libraries and system components it requires.
Except for the Linux kernel.</p>
<p>It runs on the host's kernel, in a process namespace separated from the host's processes.</p>
<p>Windows and MacOS need a Linux VM to use containers.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            
            <aside class="source">
              Source: <a href="slides.md">slides.md</a>
            </aside>
            
            <aside class="page_number">
              3/7
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: slides.md -->
      <div class="slide-wrapper">
        <div class="slide slide-4">
          <div class="inner">
            
            <header><h1>Docker and Docker Compose</h1></header>
            
            
            <section><p>Docker: an implementation of containers.</p>
<p>There are more container technologies, e.g. Podman.</p>
<p>Docker Compose: defining a set of containers cooperating with each other.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
            </section>
          </div>
          <footer>
            
            
            <aside class="source">
              Source: <a href="slides.md">slides.md</a>
            </aside>
            
            <aside class="page_number">
              4/7
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: slides.md -->
      <div class="slide-wrapper">
        <div class="slide slide-5">
          <div class="inner">
            
            <header><h1>Why have local tests with containers?</h1></header>
            
            
            <section><ul>
<li>higher probability that app really works vs. mock-only testing</li>
<li>faster development by enabling local experimentation</li>
<li>easier on-boarding of new team members</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <p>Not being able to play with the app is a huge detriment.
You will have more bugs, longer development time.</p>
<p>Best thing is a local setup, without the need for internet even (working on the train can be quite effective).
Some dev instance (or spawnable instances, maybe with Helm) is good.
Anything that the developer can change and observe.
But local ones are the easiest/fastest to work with. And cheapest :)</p>
            
            </section>
          </div>
          <footer>
            
            
            <aside class="source">
              Source: <a href="slides.md">slides.md</a>
            </aside>
            
            <aside class="page_number">
              5/7
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: slides.md -->
      <div class="slide-wrapper">
        <div class="slide slide-6">
          <div class="inner">
            
            <header><h1>The sample app (TODO)</h1></header>
            
            
            <section><p>Python REST API with an SQL database.</p>
<p>TODO prepare... experiments? Testing sample app?
Don't show the code when it's not necessary.
Focus on the test code and ideas behind it.</p>
<p>Show the code file, the migrations.</p>
<p>Run it locally, show how to set it up with Docker.
Ping it to demonstrate it's working. We did a basic local test now.
Satisfy <code>git pull &amp;&amp; make run</code> requirement.</p>
<p>Waiting for the DB to get up in the migrations.</p></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <p>Najpierw, jakaś przykładowa aplikacja - API, baza danych, migracje
Buduj ją z testami od razu.
Pokaż odpalanie jedną komendą
Pokaż przykłady jednostkowych, zintegrowanych, external (na cały feature).</p>
<p>This minimal app - how would you check that it's working? Just run it.
Ok, let's write down the command to do it.
Now everybody will be able to run it.</p>
<p>Stopniowo przechodź przez wszystkie obiecane tematy.</p>
            
            </section>
          </div>
          <footer>
            
            
            <aside class="source">
              Source: <a href="slides.md">slides.md</a>
            </aside>
            
            <aside class="page_number">
              6/7
            </aside>
          </footer>
        </div>
      </div>
      
      <!-- slide source: slides.md -->
      <div class="slide-wrapper">
        <div class="slide slide-7">
          <div class="inner">
            
            <header><h1>Techniques to show (NOT A SLIDE)</h1></header>
            
            
            <section><p>Techniques:
- organizing the project so that a local instance of the app can be run with two commands: <code>git clone &amp;&amp; make run</code>
- separation of unit, integrated, and functional tests (explain them)
- not resetting the test environment between tests
- local and CI test parity
- debugging code running in containers
- using "Docker mounts" to enable fast application reloading while editing code
- changes to the production code that make testing easier (configurable wait times, launching coverage)</p>
<ul>
<li>test code is outside of the container (additional)</li>
<li>async tests, waiting for stuff (additional)</li>
<li>destructive/non-destructive docker-compose tests (additional);
  non-destructive run with xdist before the destructive tests are run;
  mark destructive ones with pytest-mark;
  destructive example: graceful app shutdown</li>
</ul></section>
            
          </div>
          <div class="presenter_notes">
            <header><h1>Presenter Notes</h1></header>
            <section>
            
              <h3>Single command to run the app locally</h3>
<p>Aplikacja też powinna być budowana do dockera.</p>
<h3>Shortly about functional and integrated tests</h3>
<p>Sometimes the code's so simple that it won't need unit tests, though.</p>
<p>Unit/integrated/external test directories.</p>
<h3>using real local DBs in tests</h3>
<p>not fakes provided by frameworks, like in Django.
Testy są dużo bardziej realistyczne w takim przypadku.
Pozwala używać i sprawdzać więcej funkcji bazy danych / data store'a, np. triggery, indexy, itp.</p>
<p>It's good to have some layer of abstraction so that not all tests require a DB.
I don't know what frameworks you use, but Django is awful in that aspect - it encourages using ORM objects a lot,
because tests will magically work in memory.</p>
<h3>Local dev tests and CI test parity</h3>
<p>CI can run ones integrated with other apps.</p>
<p>You can use tools like pre-commit locally. I just use Makefiles.</p>
<p>CI - would be best if the image we'll be using is the same that will be pushed out.
So build image first, then run functional tests with it.</p>
<h3>test code is outside of the container</h3>
<p>App configs for different kinds of tests (functional in docker, integrated in localhost).
Wartości configów (jak adres bazy) pod testy integracyjne (łączymy się z localhosta) i funkcjonalne
(łączymy się z kontenera).</p>
<p>Można też testy wsadzać w kontener, ale ja tego nie robię.</p>
<h3>No full setup/teardown</h3>
<p>More like tests against a deployed app.</p>
<p>Makes the app and the tests more robust. The code needs to handle real issues.</p>
<p>With full setup all the time it takes a long time.</p>
<h3>docker mounts for code reloading</h3>
<p>Pierwszy krok to mounty i restartowanie.</p>
<p>Drugi to live reload. Frameworki mogą mieć takie opcje - pokaż z FastAPI.
Tutaj też pokaż overloading domyślnego polecenia w compose dla potrzeb developmentu.
Ale przydałoby się mieć jakieś testy z domyślnym poleceniem. Może jakieś testy mogą wyłączać polecenie z compose.
Albo może ono być w lokalnym override, którego nie będzie w CI.
Tradeoffy co do parity.</p>
<p>Możecie też używać jakiś live-reload frameworków, albo czegoś takiego jak <code>entr</code> w poleceniu dockera.
Nie dawałbym live reload w wersji produkcyjnej, tylko.</p>
<h3>Async tests</h3>
<p>If you're doing real calls you might need to wait for results.</p>
<p>Many flaky tests showed me real race conditions.</p>
<p>Use retrying decorators (like tenacity) liberally in tests.</p>
<p>You might wanna tune the configs in tests</p>
<h3>Code changes that help with tests</h3>
<p>E.g. coverage hooks, additional endpoints behind feature flags, synchronization points.
Dodawanie jakiś testowych endpointów do kodu - też OK. Można je chować za jakąś opcją (feature flags).</p>
<p>100% coverage without overuse of mocks is possible.</p>
<p>Test-enabling code can be a part of the product. Testability is a feature.</p>
<h3>Additional things</h3>
<p><strong>Fast docker builds</strong> with sensible command sorting - install dependencies (use caches), then add your code.</p>
<p><strong>Design your code with testability in mind.</strong>
You can chunk up the code better then.
Take care of more things with unit tests. So that integrated and functional tests will not multiply too much.
Separation of concerns is important.</p>
<p><strong>Guerilla testing</strong></p>
<p>Some patterns (like ORM because it lets you test the DB code without a real DB) become less appealing, as well.
Show the tests with triggers. Why bother? Locking is good, etc.</p>
<p>If you can reliably test more. You can really treat external apps as part of your app. Like DBs. Or Redis.</p>
<p><strong>Centralize your logs?</strong>
Talk about logs in the context of debugging?</p>
<h3>Localstack</h3>
<p>Only for AWS.
Azure has some local emulation https://learn.microsoft.com/en-us/answers/questions/579764/local-development-with-azure-services-specifically</p>
<p>GCP has <a href="https://cloud.google.com/sdk/gcloud/reference/beta/emulators">some emulators</a>
and it looks like the code using the <a href="https://cloud.google.com/functions/docs/functions-framework">functions framework</a>
can run locally.</p>
<h3>Mountebank</h3>
            
            </section>
          </div>
          <footer>
            
            
            <aside class="source">
              Source: <a href="slides.md">slides.md</a>
            </aside>
            
            <aside class="page_number">
              7/7
            </aside>
          </footer>
        </div>
      </div>
      
    </div>
  </div>
  
  <div id="toc" class="sidebar hidden">
    <h2>Table of Contents</h2>
    <table>
      <caption>Table of Contents</caption>

<!-- macro for generating subsection of TOC -->

<!-- end of macro -->

      <!-- generating sections of TOC -->
      
      <tr id="toc-row-1">
        <th><a href="#slide:1">Developer workflow with local tests using Docker Compose</a></th>
        <td><a href="#slide:1">1</a></td>
      </tr>
      
      
      <tr id="toc-row-2">
        <th><a href="#slide:2">About me (TODO - wywal, chyba)</a></th>
        <td><a href="#slide:2">2</a></td>
      </tr>
      
      
      <tr id="toc-row-3">
        <th><a href="#slide:3">What's a container?</a></th>
        <td><a href="#slide:3">3</a></td>
      </tr>
      
      
      <tr id="toc-row-4">
        <th><a href="#slide:4">Docker and Docker Compose</a></th>
        <td><a href="#slide:4">4</a></td>
      </tr>
      
      
      <tr id="toc-row-5">
        <th><a href="#slide:5">Why have local tests with containers?</a></th>
        <td><a href="#slide:5">5</a></td>
      </tr>
      
      
      <tr id="toc-row-6">
        <th><a href="#slide:6">The sample app (TODO)</a></th>
        <td><a href="#slide:6">6</a></td>
      </tr>
      
      
      <tr id="toc-row-7">
        <th><a href="#slide:7">Techniques to show (NOT A SLIDE)</a></th>
        <td><a href="#slide:7">7</a></td>
      </tr>
      
      
    </table>
  </div>
  
  <div id="help" class="sidebar hidden">
    <h2>Help</h2>
    <table>
      <caption>Help</caption>
      <tr>
        <th>Table of Contents</th>
        <td>t</td>
      </tr>
      <tr>
        <th>Exposé</th>
        <td>ESC</td>
      </tr>
      <tr>
        <th>Presenter View</th>
        <td>p</td>
      </tr>
      <tr>
        <th>Source Files</th>
        <td>s</td>
      </tr>
      <tr>
        <th>Slide Numbers</th>
        <td>n</td>
      </tr>
      <tr>
        <th>Toggle screen blanking</th>
        <td>b</td>
      </tr>
      <tr>
        <th>Show/hide next slide</th>
        <td>c</td>
      </tr>
      <tr>
        <th>Notes</th>
        <td>2</td>
      </tr>
      <tr>
        <th>Help</th>
        <td>h</td>
      </tr>
    </table>
    <br>
    <strong>Generated with Darkslide 6.0.0</strong>
  </div>
  <script>main()</script>
</body>
</html>